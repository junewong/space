<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>康德生命游戏</title>
	<script src="./js/Grids.js"></script>
	<script src="./js/Cell.js"></script>
	<style>
		.grid-row  {
			display: block;
			clear: both;
		}
		.grid-cell {
			float: left;
			background-color: white;
			border: 1px solid rgb(225, 225, 225);
		}

		.grid-cell.alive {
			background-color: green;
		}

	</style>
</head>
<body>

<table>
	<tr>
		<td>
			<div id="container"></div>
		</td>
		<td>
			<div>
				<h4>最高：<span id="maxScore">0</span></h4>
				<h4>当前：<span id="currentScore">0</span></h4>
				<h4>第<span id="step">0</span>步</h4>
			</div>
			<div>
				<button id="nextButton">下一步</button>
			</div>
			<div>
				<button id="playButton">开始/暂停</button>
			</div>
			<div>
				<br/></br/>
				<button id="resetButton">清空</button>
			</div>
			<div>
				<br/>
				<br/>
				<input type="text" id="code" name="code" size="10"/>
				<br/>
				<button id="generateButton">生成代码</button>
				<br/>
				<button id="redrawButton">复盘</button>
			</div>
		</td>
	</tr>
</table>


	<script>

		window.onload = function() {

			// Score:
			var maxScore = 0, currentScore = 0, step = 0;

			// Grids:

			var wLength = 50, hLength = 34, size = 20;

			var grids = new Grids( wLength, hLength, size, size );
			grids.createAt( document.getElementById( 'container' ) );

			grids.onClick( function( x, y, grid ) {
				//console.log( "click " + x + ", " + y );///
				if ( false == isPlaying ) {
					var id = Cell.getId( x, y );
					var cell = cellMap[ id ];
					if ( cell ) {
						cell.setLive( cell.isAlive() ? 0 : 1 );
					}
				}
			});

			// Cells:

			var cellList = [];
			var cellMap = {};

			for ( var y = 0; y < hLength; y++ ) {

				for ( var x = 0; x < wLength; x++ ) {
					var cell = new Cell( x, y );
					var id = cell.getId();
					cellList.push( cell );
					cellMap[ id ] = cell;

					cell.onFetchCell( function( x, y, id ) {
						var cell = cellMap[ id ];
						return cell;
					});

					cell.onChange( function( life ) {
						//console.log( this.getId() + " : " + life );///
						var grid =  grids.getGrid( this.x, this.y );
						if ( this.isAlive() ) {
							grid.className = 'grid-cell alive';
						} else {
							grid.className = 'grid-cell';
						}

					});
				}
			};

			function eachCell( callback ) {
				for ( var i = 0; i < cellList.length; i++ ) {
					var cell = cellList[i];
					if ( ! cell ) continue;
					callback( cell );
				}
			};

			function run() {
				currentScore = 0;

				eachCell( function( cell ) {
					cell.checkAlive();
				});

				eachCell( function( cell ) {
					cell.change();

					if ( cell.isAlive() ) {
						currentScore ++;
					}
				});

				// show info:
				step ++;
				maxScore = Math.max( maxScore, currentScore );
				document.getElementById( 'maxScore' ).innerHTML = maxScore;
				document.getElementById( 'currentScore' ).innerHTML = currentScore;
				document.getElementById( 'step' ).innerHTML = step;


			};

			function reset() {
				eachCell( function( cell ) {
					cell.setLive( CELL_DEATH );
				});
			};

			function getCode() {
				var points = [];
				eachCell( function( cell ) {
					if ( cell.isAlive() ) {
						points.push( '['  + cell.x + ',' +  cell.y + ']' );
					}
				});
				return '[' + points.join(',') + ']';
			}

			function initWithCode( code ) {
				if ( !code ) return;
				var points = eval( code );
				reset();
				init( points );
			}


			// events:

			document.getElementById( 'playButton' ).onclick =  function() {
				/*
				if ( ! handle  ) {
					//handle = setInterval( run, 250 );

				} else {
					//clearInterval( handle );
				}
				*/
				if ( handle ) {
					isPlaying = false;
					cancelAnimationFrame(handle);
					handle  = null;

				} else {
					isPlaying = true;
					autoRun();
					
				}
			};

			document.getElementById( 'nextButton' ).onclick =  function() {
				if ( false == isPlaying ) {
					run();
				}
			};

			document.getElementById( 'resetButton' ).onclick =  function() {
				if ( false == isPlaying ) {
					reset();
				}
			};

			document.getElementById( 'generateButton' ).onclick =  function() {
				if ( false == isPlaying ) {
					var code = getCode();
					document.getElementById( 'code' ).value = code;
				}
			};

			document.getElementById( 'redrawButton' ).onclick =  function() {
				if ( false == isPlaying ) {
					var code = document.getElementById( 'code' ).value;
					initWithCode( code );
				}
			};


			// run:

			var handle;
			var isPlaying = false;
			function autoRun() {
				// 获取每次的动画帧
				setTimeout( function() {
					if ( isPlaying ) {
						handle = requestAnimationFrame( autoRun );
						run();
					}
				}, 150 );
			}


			// init if need:

			function init( points ) {

				var points = points || [];
				//var points = [ [12, 12], [12, 13], [12, 14], [13, 14], [13, 15], [14, 14] ];
				//var points = [ [10, 10], [10, 12] ];
				//var points = [ [0, 0], [0, 1], [1, 0], [1, 1], [1, 2], [2, 2], [3, 1] ];

				for ( var i in points ) {
					var p = points[i];
					var id = Cell.getId( p[0], p[1] );
					var cell = cellMap[ id ];
					if ( cell ) {
						cell.setLive( CELL_ALIVE );
					}
				};
			};

			init();
		};
	</script>
</body>
</html>
